<html>
<head>
    <title>Html-Qrcode Demo</title>
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v1.9.8/dist/alpine.js" defer></script>
<body>
    <h1>Q4</h1>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@9.0.1/public/assets/styles/choices.min.css">
<div class="_dp-f _fdrt-cl _alit-ct _w-100pct"
     x-data="data()"
     x-init="() => {
         document.getElementById('page-layout').classList.remove('_pdbt-144px')
     }">
    <h1 class="_ffml-semibold _fw-600 _fs-40 _mgbt-16px">QR Code Scanner</h1>
    <select name="camera" id="camera"></select>
    <div id="qr-scanner" class="_mgt-32px _w-480px _bdw-2px _bdcl-white _bdrd-12px"></div>
</div>
</div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/1.2.4/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js@9.0.1/public/assets/scripts/choices.min.js"></script>

<script>

window.data = function () {
    return {}
}

document.addEventListener('DOMContentLoaded', function () {
    let $camera = document.getElementById("camera")
    let html5QrCode
    let userID = ''

    const camera = new Choices(document.querySelector('#camera'), {
        searchEnabled: false,
        itemSelectText: '',
    })

    Html5Qrcode.getCameras().then(devices => {
        let list = []
        for (let i = 0; i < devices.length; i++) {
            list.push({
                value: devices[i].id, 
                label: devices[i].label
            })
        }

        camera.clearStore().setValue(list).enable()

        if (devices && devices.length) {
            html5QrCode = new Html5Qrcode('qr-scanner')
            startCamera(devices[0].id)
            camera.setChoiceByValue(devices[0].id)
        }
    }).catch(err => {})

    $camera.addEventListener('change', function() {
        stopCamera()
        startCamera(this.value)
    })

    function startCamera (cameraId) {
        html5QrCode.start(
        cameraId, 
        {
            fps: 60,    // Optional frame per seconds for qr code scanning
            qrbox: 300,  // Optional if you want bounded box UI
            aspectRatio: 1.0 
        },
        qrCodeMessage => {
            let patient = `detail?id=${qrCodeMessage}`
            let isPatientID = /P[0-9]{7}$/g
            if (userID !== qrCodeMessage && qrCodeMessage !== '' && qrCodeMessage.match(isPatientID).length === 1 ) {
                userID = qrCodeMessage
                console.log(userID, qrCodeMessage)
                window.open(patient, '_blank')
            }
        },
        errorMessage => {})
        .catch(err => {console.error(err)})
    }

    function stopCamera () {
        html5QrCode.stop().then(ignore => {
        // QR Code scanning is stopped.
        }).catch(err => {})
    }
})
</script>
</head>
</html>
